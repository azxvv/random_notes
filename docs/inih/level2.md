```plaintext
┌─────────────────┐
│  用户调用ini_parse  │  // 参数：filename, handler, user
└────────┬────────┘
         ▼
┌─────────────────┐
│  打开文件：fopen  │  // 模式"r"
└────────┬────────┘
         │
         ├─ 失败 ──────────────────────────── ┐
         │                                    │
         ▼                                    ▼
┌─────────────────┐              ┌─────────────────────┐
│ 文件打开成功？   │◄────────────┤ 打印"open failed"   │
│ （判断）        │              │ 调用perror输出错误  │
└────────┬────────┘              └──────────┬──────────┘
         │                                  │
         │  是                              │
         ▼                                  │
┌─────────────────┐                         │
│ 调用ini_parse_file │  // 参数：file, handler, user  │
└────────┬────────┘                         │
         ▼                                  │
┌─────────────────────────────────────────────┐
│ ini_parse_file调用ini_parse_stream          │
│ （reader=fgets, stream=file, ...）          │
└───────────────────────┬─────────────────────┘
                        ▼
┌─────────────────────────────────────────────┐
│ ini_parse_stream初始化                      │
│  - 缓冲区分配（栈/堆，依INI_USE_STACK）     │
│  - 初始化section、lineno等变量              │
└───────────────────────┬─────────────────────┘
                        │ 堆分配失败？
                        ├─ 是 ────────────┐
                        │                 │
                        ▼                 ▼
┌─────────────────┐               ┌─────────────────┐
│ 循环读取行：     │              │ 返回-2（内存错）│
│ reader(line, ...)│              └────────┬────────┘
└────────┬────────┘                        │
         │ 读取结束？（NULL）              │
         ├─ 是 ────────────┐               │
         │                 │               │
         ▼                 ▼               │
┌─────────────────┐    ┌─────────────────┐ │
│ 处理当前行      │    │ 释放缓冲区      │ │
│ （核心解析逻辑）│    └────────┬────────┘ │
└────────┬────────┘             │          │
         │                      │          │
         │ 行类型判断：         ▼          │
         ├─ 注释行（忽略）    ┌─────────────────┐
         ├─ 节行（[section]） │ 返回error（0或  │
         │   - 提取section    │ 错误行号）      │
         │   - 调用handler（可选）              │
         ├─ 键值对行（k=v）   └─────────────────┘
         │   - 提取name/value
         │   - 调用handler
         └─ 多行值（依INI_ALLOW_MULTILINE）
         │
         │ 解析错误？（如格式错）
         ├─ 是 ──► 记录错误行号
         │
         └─ 继续循环


```